{% extends "base.html" %}

{% block title %}{% if movie %}{{ movie.title }} - {% endif %}影片详情{% endblock %}

{% block additional_head %}
<link href="/static/css/movie.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <nav aria-label="breadcrumb" class="d-flex justify-content-between align-items-center">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Movie {{ movie.id }}</li>
            </ol>
            <a href="/refresh_movie/{{ movie.id }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </a>
        </nav>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <img src="/images/covers/{{ movie.id }}.jpg" 
                 class="card-img-top" 
                 alt="{{ movie.id }}" 
                 style="max-width: 150%; height: auto; cursor: pointer;"
                 data-bs-toggle="modal" 
                 data-bs-target="#imageModal"
                 data-src="/images/covers/{{ movie.id }}.jpg"
                 title="Click to enlarge">
            <div class="card-body">
                <h5 class="card-title">{{ movie.id }}</h5>
                <p class="card-text">
                    <strong>Release Date:</strong> {{ movie.date }}
                </p>
                <div class="d-grid gap-2">
                    {% if movie.is_favorite %}
                    <button class="btn btn-danger" onclick="toggleFavorite('{{ movie.id }}', this)">
                        <i class="bi bi-heart-fill"></i> Remove from Favorites
                    </button>
                    {% else %}
                    <button class="btn btn-outline-danger" onclick="toggleFavorite('{{ movie.id }}', this)">
                        <i class="bi bi-heart"></i> Add to Favorites
                    </button>
                    {% endif %}
                    
                    <a href="{{ watch_url_prefix }}/{{ movie.id }}" target="_blank" class="btn btn-primary">
                        <i class="bi bi-play-fill"></i> Watch Online
                    </a>
                    
                    <a href="/video_player/{{ movie.id }}" target="_blank" class="btn btn-outline-primary">
                        <i class="bi bi-play-circle"></i> Ad-free Player
                    </a>

                    <!-- 下载 MP4 按钮 -->
                    <button id="download-mp4-btn" class="btn btn-success" data-movie-id="{{ movie.id }}">
                        <i class="bi bi-download"></i> 下载 MP4
                    </button>
                    
                    <!-- STRM Player button -->
                    <a href="/strm/find_video/{{ movie.id }}" class="btn btn-outline-success">
                        <i class="bi bi-collection-play"></i> STRM Player
                    </a>
                    
                    <!-- 115 Cloud Player button -->
                    <a href="/find_cloud115_by_video_id/{{ movie.id }}" class="btn btn-outline-secondary" style="background-color: #f8f0ff; border-color: #6f42c1; color: #6f42c1;">
                        <i class="bi bi-cloud-arrow-down"></i> 115 Player
                    </a>
                    
                    <!-- Jellyfin Player button -->
                    <a href="/jellyfin_player/{{ movie.id }}" class="btn btn-outline-secondary" style="background-color: #e6f7ff; border-color: #0ca5e9; color: #0ca5e9;">
                        <i class="bi bi-play-circle"></i> Jellyfin Player
                    </a>
                    
                    <!-- 115 Library Files section -->
                    <div class="mt-3" id="cloud115-files-container" style="display: none;">
                        <div id="cloud115-files-list" class="d-flex flex-wrap gap-2 mt-2">
                            <!-- Files will be loaded here dynamically -->
                            <div class="spinner-border spinner-border-sm text-secondary" id="cloud115-files-loading" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="text-muted" id="cloud115-files-loading-text">Loading files from 115 library...</small>
                        </div>
                    </div>
                    
                    <!-- Jellyfin Library Files section -->
                    <div class="mt-3" id="jellyfin-files-container" style="display: none;">
                        <div id="jellyfin-files-list" class="d-flex flex-wrap gap-2 mt-2">
                            <!-- Files will be loaded here dynamically -->
                            <div class="spinner-border spinner-border-sm text-secondary" id="jellyfin-files-loading" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="text-muted" id="jellyfin-files-loading-text">Loading files from Jellyfin library...</small>
                        </div>
                    </div>
                    
                    {% if movie.genres and movie.genres|length > 0 %}
                    <div class="mt-3">
                        <strong>Genres:</strong>
                        <div>
                            {% for genre in movie.genres %}
                            <a href="/search_keyword?filterType=genre&filterValue={{ genre.id }}" class="badge bg-warning me-1 mb-1 text-decoration-none">
                                {{ genre.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ movie.title }}</h5>
                <div class="btn-group" role="group">
                    {% if not movie.translated_title or not movie.translated_summary %}
                    <button class="btn btn-sm btn-outline-primary" id="translate-btn" 
                            data-movie-id="{{ movie.id }}" 
                            data-title="{{ movie.title }}"
                            {% if movie.summary %}data-summary="{{ movie.summary }}"{% endif %}
                            onclick="translateMovie(this)">
                        <i class="bi bi-translate"></i> Translate
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-outline-success" id="refresh-translate-btn" 
                            data-movie-id="{{ movie.id }}" 
                            data-title="{{ movie.title }}"
                            {% if movie.summary %}data-summary="{{ movie.summary }}"{% endif %}
                            onclick="refreshTranslation(this)">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Translation
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if movie.translated_title %}
                <div class="mb-3 alert alert-info">
                    <strong>译文标题:</strong> {{ movie.translated_title }}
                </div>
                {% else %}
                <div id="translated-title-container" class="mb-3 alert alert-info" style="display: none;">
                    <strong>译文标题:</strong> <span id="translated-title-text"></span>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong class="small">ID:</strong> <span class="small">{{ movie.id }}</span>
                    </div>
                    <div class="col-md-4">
                        <strong class="small">Release Date:</strong> <span class="small">{{ movie.date }}</span>
                    </div>
                    <div class="col-md-4">
                        <strong class="small">Duration:</strong> <span class="small">{{ movie.videoLength|default('N/A') }} min</span>
                    </div>
                </div>
                
                <hr>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong class="small">Producer:</strong><br>
                        {% if movie.producer_obj and movie.producer_obj.id %}
                        <a href="/search_keyword?filterType=studio&filterValue={{ movie.producer_obj.id }}" class="text-decoration-none small">
                            {{ movie.producer_obj.name|default(movie.producer) }}
                        </a>
                        {% else %}
                        <span class="small">{{ movie.producer }}</span>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <strong class="small">Publisher:</strong><br>
                        {% if movie.publisher and movie.publisher.id %}
                        <a href="/search_keyword?filterType=label&filterValue={{ movie.publisher.id }}" class="text-decoration-none small">
                            {{ movie.publisher.name|default('N/A') }}
                        </a>
                        {% else %}
                        <span class="small">{{ movie.publisher.name|default('N/A') }}</span>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <strong class="small">Director:</strong><br>
                        {% if movie.director and movie.director.id %}
                        <a href="/search_keyword?filterType=director&filterValue={{ movie.director.id }}" class="text-decoration-none small">
                            {{ movie.director.name|default('N/A') }}
                        </a>
                        {% else %}
                        <span class="small">{{ movie.director.name|default('N/A') }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <hr>
                
                {% if movie.series and movie.series.id %}
                <div class="mb-3">
                    <strong class="small">Series:</strong><br>
                    <a href="/search_keyword?filterType=series&filterValue={{ movie.series.id }}" class="text-decoration-none small">
                        {{ movie.series.name }}
                    </a>
                </div>
                {% endif %}
                
                {% if movie.translated_title %}
                <div class="mb-3">
                    <strong>Translated Title:</strong> 
                    <p>{{ movie.translated_title }}</p>
                </div>
                {% endif %}
                
                {% if movie.summary %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Summary:</strong>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#summaryContent" aria-expanded="false" aria-controls="summaryContent">
                            <span class="summary-toggle-text">展开</span>
                            <i class="bi bi-chevron-down summary-toggle-icon"></i>
                        </button>
                    </div>
                    <div class="collapse" id="summaryContent">
                        <div style="white-space: pre-line;">{{ movie.summary }}</div>
                        {% if movie.translated_summary %}
                        <div class="card bg-light mt-2">
                            <div class="card-body">
                                <strong>译文简介:</strong>
                                <div style="white-space: pre-line;">{{ movie.translated_summary }}</div>
                            </div>
                        </div>
                        {% else %}
                        <div id="translated-summary-container" class="card bg-light mt-2" style="display: none;">
                            <div class="card-body">
                                <strong>译文简介:</strong>
                                <div id="translated-summary-text" style="white-space: pre-line;"></div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if movie.user_reviews and movie.user_reviews|length > 0 %}
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>用户评价 ({{ movie.user_reviews|length }}条):</strong>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#userReviewsContent" aria-expanded="false" aria-controls="userReviewsContent">
                                    <span class="reviews-toggle-text">展开</span>
                                    <i class="bi bi-chevron-down reviews-toggle-icon"></i>
                                </button>
                            </div>
                            <div class="collapse" id="userReviewsContent">
                                {% for review in movie.user_reviews %}
                                <div class="card mt-2">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                {% if review.title %}
                                                <h6 class="card-title mb-1">{{ review.title }}</h6>
                                                {% endif %}
                                                {% if review.rating %}
                                                <span class="badge bg-warning me-2">评分: {{ review.rating }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="text-muted small">
                                                {% if review.reviewer %}
                                                <div>评价者: {{ review.reviewer }}</div>
                                                {% endif %}
                                                {% if review.post_date %}
                                                <div>{{ review.post_date }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if review.comment %}
                                        <div class="card-text" style="white-space: pre-line;">{{ review.comment }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% elif not has_summary %}
                <!-- Summary loading placeholder -->
                <div class="mb-3" id="summary-loading-container">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Summary:</strong>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#summaryContent" aria-expanded="false" aria-controls="summaryContent">
                            <span class="summary-toggle-text">展开</span>
                            <i class="bi bi-chevron-down summary-toggle-icon"></i>
                        </button>
                    </div>
                    <div class="collapse" id="summaryContent">
                        <div class="d-flex align-items-center mt-2">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Loading summary from Provider...</span>
                        </div>
                    </div>
                </div>
                <!-- Summary will be loaded here -->
                <div class="mb-3" id="summary-container" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Summary:</strong>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#summaryContent" aria-expanded="false" aria-controls="summaryContent">
                            <span class="summary-toggle-text">展开</span>
                            <i class="bi bi-chevron-down summary-toggle-icon"></i>
                        </button>
                    </div>
                    <div class="collapse" id="summaryContent">
                        <div id="summary-text" style="white-space: pre-line;"></div>
                        <div id="async-translated-summary-container" class="card bg-light mt-2" style="display: none;">
                            <div class="card-body">
                                <strong>译文简介:</strong>
                                <div id="async-translated-summary-text" style="white-space: pre-line;"></div>
                            </div>
                        </div>
                        <!-- User reviews will be loaded here if available -->
                        <div id="async-user-reviews-container" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong id="async-user-reviews-title">用户评价:</strong>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#asyncUserReviewsContent" aria-expanded="false" aria-controls="asyncUserReviewsContent">
                                    <span class="async-reviews-toggle-text">展开</span>
                                    <i class="bi bi-chevron-down async-reviews-toggle-icon"></i>
                                </button>
                            </div>
                            <div class="collapse" id="asyncUserReviewsContent">
                                <div id="async-user-reviews-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if movie.actors and movie.actors|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Actors</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for actor in movie.actors %}
                    {% set detail = actors_detail.get(actor.id) if actors_detail else none %}
                    {% set has_av_league = detail.av_league_updated if detail else false %}
                    <div class="col-md-3 col-sm-4 mb-4 text-center">
                        <a href="/search_keyword?filterType=star&filterValue={{ actor.id }}" class="text-decoration-none">
                            <div style="position: relative; display: inline-block;">
                                <img src="/images/actor/{{ actor.id }}.jpg"
                                     class="actor-img rounded-circle mb-2"
                                     alt="{{ actor.name }}"
                                     style="width: 100px; height: 100px; object-fit: cover;"
                                     data-bs-toggle="tooltip"
                                     data-bs-placement="top"
                                     data-bs-html="true"
                                     data-bs-custom-class="actor-tooltip"
                                     title="{{ actor.name }}
                                        {% if detail %}
                                            {% if detail.birthday %}<br><span style='color: #e0e0e0;'>生日: {{ detail.birthday }}</span>{% endif %}
                                            {% if detail.age %}<br><span style='color: #e0e0e0;'>年龄: {{ detail.age }}</span>{% endif %}
                                            {% if detail.height %}<br><span style='color: #e0e0e0;'>身高: {{ detail.height }}</span>{% endif %}
                                            {% if detail.cup %}<br><span style='color: #e0e0e0;'>罩杯: {{ detail.cup }}</span>{% endif %}
                                            {% if detail.bust or detail.waistline or detail.hipline %}<br><span style='color: #e0e0e0;'>三围: {{ detail.bust or '-' }} - {{ detail.waistline or '-' }} - {{ detail.hipline or '-' }}</span>{% endif %}
                                            {% if detail.birthplace %}<br><span style='color: #e0e0e0;'>出生地: {{ detail.birthplace }}</span>{% endif %}
                                            {% if detail.hobby %}<br><span style='color: #e0e0e0;'>爱好: {{ detail.hobby }}</span>{% endif %}
                                            {% if has_av_league %}
                                                <hr style='margin: 5px 0; border-color: #444;'>
                                                <span style='color: #4fc3f7; font-size: 11px;'>[AV-League 数据]</span>
                                                {% if detail.debut_date %}<br><span style='color: #e0e0e0;'>出道: {{ detail.debut_date }}</span>{% endif %}
                                                {% if detail.video_count %}<br><span style='color: #e0e0e0;'>作品: {{ detail.video_count }}部</span>{% endif %}
                                                {% if detail.solo_count %}<br><span style='color: #e0e0e0;'>单体: {{ detail.solo_count }}部</span>{% endif %}
                                                {% if detail.tags %}<br><span style='color: #e0e0e0;'>标签: {{ detail.tags|join(', ') }}</span>{% endif %}
                                            {% endif %}
                                        {% endif %}">
                                <span class="badge {% if has_av_league %}bg-success{% else %}bg-secondary{% endif %}"
                                      style="font-size: 9px; position: absolute; top: 0; right: 0; cursor: pointer; opacity: 0.9;"
                                      onclick="event.preventDefault(); event.stopPropagation(); refreshActorAvLeague('{{ actor.id }}', '{{ actor.name }}')"
                                      data-bs-toggle="tooltip"
                                      title="点击刷新 AV-League 数据">
                                    AV
                                </span>
                            </div>
                            <p style="margin: 0;">{{ actor.name }}</p>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if movie.magnet_links and movie.magnet_links|length > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Magnet Links</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Size</th>
                                <th>Date</th>
                                <th>Quality</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for magnet in movie.magnet_links %}
                            <tr>
                                <td>
                                    {% if magnet.title %}
                                    {{ magnet.title }}
                                    {% else %}
                                    {{ magnet.name }}
                                    {% endif %}
                                    {% if magnet.has_subtitle %}
                                    <span class="badge bg-success">字幕</span>
                                    {% endif %}
                                </td>
                                <td>{{ magnet.size }}</td>
                                <td>{{ magnet.date }}</td>
                                <td>
                                    {% if magnet.is_hd or magnet.isHD %}
                                    <span class="badge bg-primary">HD</span>
                                    {% else %}
                                    <span class="badge bg-secondary">SD</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary copy-btn" 
                                            data-magnet="{{ magnet.link }}" 
                                            onclick="copyMagnet(this)">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-outline-info add-to-115-btn"
                                            data-magnet="{{ magnet.link }}"
                                            data-title="{% if magnet.title %}{{ magnet.title }}{% else %}{{ magnet.name }}{% endif %}"
                                            onclick="showAddTo115Modal(this)">
                                        <i class="bi bi-cloud-arrow-down"></i> 添加115离线
                                    </button>
                                    <button class="btn btn-sm btn-outline-success add-to-library-btn"
                                            data-magnet="{{ magnet.link }}"
                                            data-title="{% if magnet.title %}{{ magnet.title }}{% else %}{{ magnet.name }}{% endif %}"
                                            data-movie-id="{% if movie %}{{ movie.id }}{% endif %}"
                                            onclick="addToLibrary(this)">
                                        <i class="bi bi-collection"></i> 加入片库
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if movie and movie.samples and movie.samples|length > 0 %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Sample Images</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for sample in movie.sample_images %}
                    <div class="col-md-3 col-sm-6 mb-4">
                        <img src="/images/{{ movie.id }}/sample_{{ sample.index }}.jpg" 
                             class="img-fluid rounded shadow sample-img"
                             {% if sample.can_enlarge %}
                             data-bs-toggle="modal" 
                             data-bs-target="#imageModal"
                             data-src="/images/{{ movie.id }}/sample_{{ sample.index }}.jpg"
                             style="cursor: pointer;"
                             title="Click to enlarge"
                             {% else %}
                             title="No larger image available"
                             {% endif %}
                             alt="{{ movie.title }} - Sample {{ sample.index }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add to 115 Offline Download Modal -->
<div class="modal fade" id="addTo115Modal" tabindex="-1" aria-labelledby="addTo115ModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTo115ModalLabel">添加115云下载任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-primary mb-3">
                    <p id="magnetInfo" class="mb-0"></p>
                </div>
                
                <!-- 面包屑导航 -->
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb" id="cloud115DLBreadCrumb">
                        <li class="breadcrumb-item active" data-folder-id="0">根目录</li>
                    </ol>
                </nav>
                
                <!-- 115目录浏览 -->
                <div class="table-responsive">
                    <table class="table table-hover" id="cloud115DLFileList">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 40px;">#</th>
                                <th scope="col">名称</th>
                                <th scope="col" style="width: 120px;">大小</th>
                                <th scope="col" style="width: 160px;">修改时间</th>
                                <th scope="col" style="width: 80px;">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="cloud115DLLoading">
                                <td colspan="5" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <span class="ms-2">加载中...</span>
                                </td>
                            </tr>
                            <!-- 文件列表将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- 无文件时显示 -->
                <div id="cloud115DLNoFiles" class="alert alert-info text-center d-none">
                    <i class="fas fa-info-circle me-2"></i> 当前目录为空
                </div>
                
                <!-- 未登录提示 -->
                <div id="cloud115DLNotLoggedIn" class="alert alert-warning text-center d-none">
                    <i class="fas fa-exclamation-circle me-2"></i> 请先登录115云盘
                    <button type="button" class="btn btn-sm btn-outline-primary ms-3" data-bs-toggle="modal" data-bs-target="#login115Modal" data-bs-dismiss="modal">
                        <i class="fas fa-sign-in-alt me-1"></i> 去登录
                    </button>
                </div>
                
                <!-- 显示当前选中的文件夹 -->
                <div id="selectedDLFolderInfo" class="alert alert-success mt-3 d-none">
                    <strong>保存位置：</strong> <span id="selectedDLFolderName"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddTo115" disabled>确定添加</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">{{ movie.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid" alt="Full size image">
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Fetch and display 115 library files for the current movie ID
    document.addEventListener('DOMContentLoaded', function() {
        // 绑定下载 MP4 按钮
        const dlBtn = document.getElementById('download-mp4-btn');
        if (dlBtn) {
            dlBtn.addEventListener('click', async function() {
                const movieId = this.getAttribute('data-movie-id');
                if (!movieId) return;
                this.disabled = true;
                const originalHTML = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 准备中...';

                try {
                    const resp = await fetch('/api/download_mp4', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ movie_id: movieId, filename: movieId + '.mp4' })
                    });
                    const data = await resp.json();
                    if (!data.success) throw new Error(data.message || '启动下载失败');

                    const taskId = data.task_id;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 下载中...';

                    // 轮询状态
                    const poll = async () => {
                        const s = await fetch('/api/download_mp4/status/' + taskId);
                        const st = await s.json();
                        if (!st.success) throw new Error(st.message || '查询状态失败');
                        if (st.status === 'completed' && st.download_url) {
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-check-circle"></i> 下载完成';
                            // 弹出下载
                            window.open(st.download_url, '_blank');
                            return;
                        } else if (st.status === 'error') {
                            this.disabled = false;
                            this.innerHTML = originalHTML;
                            alert('下载失败：' + (st.error || '未知错误'));
                            return;
                        } else {
                            // 继续轮询
                            setTimeout(poll, 3000);
                        }
                    };
                    setTimeout(poll, 2000);
                } catch (e) {
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                    alert('下载任务启动失败：' + e.message);
                }
            });
        }
        // Check if we have a movie ID
        const movieId = "{{ movie.id }}";
        if (movieId) {
            fetchCloud115Files(movieId);
            fetchJellyfinFiles(movieId);
        }
    });
    
    function fetchCloud115Files(movieId) {
        const container = document.getElementById('cloud115-files-container');
        const filesList = document.getElementById('cloud115-files-list');
        const loading = document.getElementById('cloud115-files-loading');
        const loadingText = document.getElementById('cloud115-files-loading-text');
        
        // Show container with loading indicator
        container.style.display = 'block';
        
        // Fetch 115 library files for the movie ID
        fetch(`/api/cloud115/find_files_by_movie_id/${movieId}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicators
                loading.style.display = 'none';
                loadingText.style.display = 'none';
                
                if (data.success && data.files && data.files.length > 0) {
                    // Files found, create buttons for each
                    data.files.forEach(file => {
                        // Format file size
                        let sizeDisplay = file.size;
                        // If size is not a string or empty, format it
                        if (typeof sizeDisplay !== 'string' || !sizeDisplay.trim()) {
                            sizeDisplay = "N/A";
                        }
                        
                        // Create button
                        const button = document.createElement('button');
                        button.className = 'btn btn-sm btn-outline-secondary';
                        button.style.backgroundColor = '#f8f0ff';
                        button.style.borderColor = '#6f42c1';
                        button.style.color = '#6f42c1';
                        button.innerHTML = `<i class="bi bi-file-play"></i> ${file.name} ${sizeDisplay}`;
                        button.title = `Play ${file.name}`;
                        
                        // Add click event to play the file
                        button.addEventListener('click', () => {
                            window.open(`/cloud115/player/${file.file_id}`, '_blank');
                        });
                        
                        // Add to container
                        filesList.appendChild(button);
                    });
                } else {
                    // No files found - hide the container completely
                    container.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading 115 library files:', error);
                // Hide container on error
                container.style.display = 'none';
            });
    }
    
    function fetchJellyfinFiles(movieId) {
        const container = document.getElementById('jellyfin-files-container');
        const filesList = document.getElementById('jellyfin-files-list');
        const loading = document.getElementById('jellyfin-files-loading');
        const loadingText = document.getElementById('jellyfin-files-loading-text');
        
        // Show container with loading indicator
        container.style.display = 'block';
        
        // Fetch Jellyfin library files for the movie ID
        fetch(`/api/jellyfin/find_files_by_movie_id/${movieId}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicators
                loading.style.display = 'none';
                loadingText.style.display = 'none';
                
                if (data.success && data.files && data.files.length > 0) {
                    // Files found, create buttons for each
                    data.files.forEach(file => {
                        // Extract filename from path
                        const pathParts = file.path.split('/');
                        const fileName = pathParts[pathParts.length - 1];
                        
                        // Create button
                        const button = document.createElement('button');
                        button.className = 'btn btn-sm btn-outline-secondary';
                        button.style.backgroundColor = '#e6f7ff';
                        button.style.borderColor = '#0ca5e9';
                        button.style.color = '#0ca5e9';
                        button.innerHTML = `<i class="bi bi-file-play"></i> ${fileName}`;
                        button.title = `Play ${fileName}`;
                        
                        // Add click event to play the file
                        button.addEventListener('click', () => {
                            window.open(`/jellyfin_player/file/${file.id}`, '_blank');
                        });
                        
                        // Add to container
                        filesList.appendChild(button);
                    });
                } else {
                    // No files found - hide the container completely
                    container.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading Jellyfin library files:', error);
                // Hide container on error
                container.style.display = 'none';
            });
    }
    
    {% if not has_summary %}
    // Fetch summary asynchronously on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchMovieSummary("{{ movie_id }}");
    });
    
    // Function to fetch movie summary
    function fetchMovieSummary(movieId) {
        fetch("/api/get_movie_summary/" + movieId)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                // Hide loading spinner
                document.getElementById('summary-loading-container').style.display = 'none';
                
                if (data.status === 'success' && data.summary) {
                    // Show summary container
                    var summaryContainer = document.getElementById('summary-container');
                    var summaryText = document.getElementById('summary-text');
                    
                    summaryText.textContent = data.summary;
                    summaryContainer.style.display = 'block';
                    
                    // Add the summary as a data attribute to the translate button (if it exists)
                    var translateBtn = document.getElementById('translate-btn');
                    if (translateBtn) {
                        translateBtn.setAttribute('data-summary', data.summary);
                    }
                    
                    // If there's a translated summary, show it
                    if (data.translated_summary) {
                        var translatedContainer = document.getElementById('async-translated-summary-container');
                        var translatedText = document.getElementById('async-translated-summary-text');
                        
                        translatedText.textContent = data.translated_summary;
                        translatedContainer.style.display = 'block';
                        
                        // If we have a translated summary, we might want to hide the translate button
                        if (translateBtn && document.getElementById('translated-title-container') && 
                            document.getElementById('translated-title-container').style.display != 'none') {
                            // Hide the button only if we have both title and summary translated
                            translateBtn.style.display = 'none';
                        }
                    }
                    
                    // If there are user reviews, load them
                    if (data.user_reviews && data.user_reviews.length > 0) {
                        loadUserReviews(data.user_reviews);
                    }
                } else {
                    // Show no summary available message
                    var summaryContainer = document.getElementById('summary-container');
                    var summaryText = document.getElementById('summary-text');
                    
                    summaryText.textContent = 'No summary available for this movie.';
                    summaryContainer.style.display = 'block';
                }
            })
            .catch(function(error) {
                console.error('Error fetching summary:', error);
                // Hide loading spinner
                document.getElementById('summary-loading-container').style.display = 'none';
                
                // Show error message
                var summaryContainer = document.getElementById('summary-container');
                var summaryText = document.getElementById('summary-text');
                
                summaryText.textContent = 'Failed to load summary. Please try again later.';
                summaryContainer.style.display = 'block';
            });
    }
    {% endif %}
    
    function toggleFavorite(movieId, button) {
        fetch(`/api/toggle_favorite/${movieId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_favorite) {
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-danger');
                button.innerHTML = '<i class="bi bi-heart-fill"></i> Remove from Favorites';
            } else {
                button.classList.remove('btn-danger');
                button.classList.add('btn-outline-danger');
                button.innerHTML = '<i class="bi bi-heart"></i> Add to Favorites';
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function copyMagnet(button) {
        const magnetLink = button.getAttribute('data-magnet');
        
        // Create a temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = magnetLink;
        document.body.appendChild(textarea);
        
        // Select and copy the text
        textarea.select();
        document.execCommand('copy');
        
        // Remove the textarea
        document.body.removeChild(textarea);
        
        // Change button text temporarily to show feedback
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i> Copied!';
        
        // Restore original button text after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 2000);
    }
    
    function openImageInNewTab(img) {
        // Try to use the original source if available
        const originalSrc = img.getAttribute('data-original-src');
        const src = originalSrc || img.src;
        window.open(src, '_blank');
    }
    
    function translateMovie(button) {
        // Get data from button attributes
        const movieId = button.getAttribute('data-movie-id');
        const originalTitle = button.getAttribute('data-title');
        let originalSummary = button.getAttribute('data-summary') || '';
        
        // If summary was loaded asynchronously, get it from the text element
        if (!originalSummary && document.getElementById('summary-text')) {
            originalSummary = document.getElementById('summary-text').textContent || '';
            // Don't try to translate placeholder messages
            if (originalSummary === 'No summary available for this movie.' || 
                originalSummary === 'Failed to load summary. Please try again later.') {
                originalSummary = '';
            }
        }
        
        // Disable the button to prevent multiple clicks
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Translating...';
        
        let translationPromises = [];
        let results = {};
        
        // Translate title if not already translated
        if (!document.getElementById('translated-title-container').style.display || 
            document.getElementById('translated-title-container').style.display === 'none') {
            const titlePromise = fetch('/api/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: originalTitle,
                    movie_id: movieId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.translated_text) {
                    results.translated_title = data.translated_text;
                    // Show the translated title
                    const container = document.getElementById('translated-title-container');
                    const textSpan = document.getElementById('translated-title-text');
                    
                    textSpan.textContent = data.translated_text;
                    container.style.display = 'block';
                } else {
                    throw new Error(data.message || 'Title translation failed');
                }
            });
            
            translationPromises.push(titlePromise);
        }
        
        // Translate summary if available and not already translated
        if (originalSummary && 
            ((!document.getElementById('translated-summary-container') || 
             document.getElementById('translated-summary-container').style.display === 'none') && 
             (!document.getElementById('async-translated-summary-container') || 
             document.getElementById('async-translated-summary-container').style.display === 'none'))) {
            const summaryPromise = fetch('/api/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: originalSummary,
                    movie_id: movieId,
                    translate_summary: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.translated_text) {
                    results.translated_summary = data.translated_text;
                    
                    // Choose the appropriate container based on which one exists
                    let container, textEl;
                    
                    if (document.getElementById('translated-summary-container')) {
                        container = document.getElementById('translated-summary-container');
                        textEl = document.getElementById('translated-summary-text');
                    } else if (document.getElementById('async-translated-summary-container')) {
                        container = document.getElementById('async-translated-summary-container');
                        textEl = document.getElementById('async-translated-summary-text');
                    } else {
                        // Create a container if none exists (rare case)
                        const summaryContainer = document.getElementById('summary-container') || 
                                               document.querySelector('.mb-3');
                        
                        if (summaryContainer) {
                            container = document.createElement('div');
                            container.id = 'dynamic-translated-summary-container';
                            container.className = 'card bg-light';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body';
                            
                            const strongEl = document.createElement('strong');
                            strongEl.textContent = '译文简介:';
                            
                            textEl = document.createElement('p');
                            textEl.id = 'dynamic-translated-summary-text';
                            
                            cardBody.appendChild(strongEl);
                            cardBody.appendChild(textEl);
                            container.appendChild(cardBody);
                            
                            summaryContainer.appendChild(container);
                        } else {
                            throw new Error('Could not find or create summary container');
                        }
                    }
                    
                    // Add the translated text and show the container
                    textEl.textContent = data.translated_text;
                    container.style.display = 'block';
                } else {
                    throw new Error(data.message || 'Summary translation failed');
                }
            });
            
            translationPromises.push(summaryPromise);
        }
        
        // Wait for all translations to complete
        Promise.all(translationPromises)
            .then(() => {
                // Save all translations to the server
                return fetch(`/api/save_translation/${movieId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(results)
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Hide the button as translation is now saved
                    button.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Enable the button again
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-translate"></i> Retry Translation';
                
                // Show error message
                alert('Translation failed: ' + error.message);
            });
    }
    
    function translateTitle(movieId, originalTitle) {
        // Legacy function - create a temporary button with the data and use it
        const tempButton = document.createElement('button');
        tempButton.setAttribute('data-movie-id', movieId);
        tempButton.setAttribute('data-title', originalTitle);
        translateMovie(tempButton);
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    function refreshTranslation(button) {
        // Get data from button attributes
        const movieId = button.getAttribute('data-movie-id');
        const originalTitle = button.getAttribute('data-title');
        let originalSummary = button.getAttribute('data-summary') || '';
        
        // If summary was loaded asynchronously, get it from the text element
        if (!originalSummary && document.getElementById('summary-text')) {
            originalSummary = document.getElementById('summary-text').textContent || '';
            // Don't try to translate placeholder messages
            if (originalSummary === 'No summary available for this movie.' || 
                originalSummary === 'Failed to load summary. Please try again later.') {
                originalSummary = '';
            }
        }
        
        // Disable the button to prevent multiple clicks
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Refreshing...';
        
        let translationPromises = [];
        let results = {};
        
        // Always translate title (refresh existing translation)
        const titlePromise = fetch('/api/translate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: originalTitle,
                movie_id: movieId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.translated_text) {
                results.translated_title = data.translated_text;
                
                // Find and update existing translated title containers
                const existingContainers = document.querySelectorAll('[id*="translated-title"]');
                existingContainers.forEach(container => {
                    if (container.id === 'translated-title-container') {
                        const textSpan = container.querySelector('#translated-title-text');
                        if (textSpan) {
                            textSpan.textContent = data.translated_text;
                            container.style.display = 'block';
                        }
                    } else {
                        // For other containers, update the text content directly
                        container.textContent = data.translated_text;
                        container.style.display = 'block';
                    }
                });
                
                // If no existing containers found, create a new one
                if (existingContainers.length === 0) {
                    const titleContainer = document.createElement('div');
                    titleContainer.id = 'translated-title-container';
                    titleContainer.className = 'mb-3 alert alert-info';
                    titleContainer.innerHTML = '<strong>译文标题:</strong> <span id="translated-title-text"></span>';
                    
                    // Insert after the title
                    const cardBody = document.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.insertBefore(titleContainer, cardBody.firstChild);
                        document.getElementById('translated-title-text').textContent = data.translated_text;
                    }
                }
            } else {
                throw new Error(data.message || 'Title translation failed');
            }
        });
        
        translationPromises.push(titlePromise);
        
        // Always translate summary if available (refresh existing translation)
        if (originalSummary) {
            const summaryPromise = fetch('/api/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: originalSummary,
                    movie_id: movieId,
                    translate_summary: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.translated_text) {
                    results.translated_summary = data.translated_text;
                    
                    // Find and update existing translated summary containers
                    const existingContainers = document.querySelectorAll('[id*="translated-summary"]');
                    let updated = false;
                    
                    existingContainers.forEach(container => {
                        const textEl = container.querySelector('[id*="translated-summary-text"]') || 
                                      container.querySelector('div[style*="white-space"]') ||
                                      container.querySelector('.card-body div');
                        
                        if (textEl) {
                            textEl.textContent = data.translated_text;
                            container.style.display = 'block';
                            updated = true;
                        }
                    });
                    
                    // If no existing containers found, create a new one in the summary section
                    if (!updated) {
                        // Find the summary content area
                        const summaryContent = document.getElementById('summaryContent') || 
                                             document.querySelector('.collapse');
                        
                        if (summaryContent) {
                            // Create translated summary container
                            const container = document.createElement('div');
                            container.id = 'refreshed-translated-summary-container';
                            container.className = 'card bg-light mt-2';
                            
                            const cardBody = document.createElement('div');
                            cardBody.className = 'card-body';
                            
                            const strongEl = document.createElement('strong');
                            strongEl.textContent = '译文简介:';
                            
                            const textEl = document.createElement('div');
                            textEl.id = 'refreshed-translated-summary-text';
                            textEl.style.whiteSpace = 'pre-line';
                            textEl.textContent = data.translated_text;
                            
                            cardBody.appendChild(strongEl);
                            cardBody.appendChild(textEl);
                            container.appendChild(cardBody);
                            
                            // Insert into summary content
                            summaryContent.appendChild(container);
                        }
                    }
                } else {
                    throw new Error(data.message || 'Summary translation failed');
                }
            });
            
            translationPromises.push(summaryPromise);
        }
        
        // Wait for all translations to complete
        Promise.all(translationPromises)
        .then(() => {
            // Re-enable the button and change text
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Translation';
            
            // Show success message
            showNotification('Translation refreshed successfully!', 'success');
            
            // Refresh the page to show updated translation from database
            setTimeout(() => {
                window.location.reload();
            }, 1500); // Wait 1.5 seconds to show the success message
        })
        .catch(error => {
            console.error('Translation refresh failed:', error);
            
            // Re-enable the button
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Translation';
            
            // Show error message
            showNotification('Translation refresh failed: ' + error.message, 'error');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Set up image modal
        const imageModal = document.getElementById('imageModal');
        if (imageModal) {
            imageModal.addEventListener('show.bs.modal', function (event) {
                // Button that triggered the modal
                const img = event.relatedTarget;
                // Extract info from data-* attributes
                const imgSrc = img.getAttribute('data-src');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imgSrc;
            });
        }
    });
    
    // 115 Cloud Download functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for 115 cloud download directory browser
        const breadcrumb = document.getElementById('cloud115DLBreadCrumb');
        const fileList = document.getElementById('cloud115DLFileList').querySelector('tbody');
        const loadingRow = document.getElementById('cloud115DLLoading');
        const noFilesAlert = document.getElementById('cloud115DLNoFiles');
        const notLoggedInAlert = document.getElementById('cloud115DLNotLoggedIn');
        const confirmBtn = document.getElementById('confirmAddTo115');
        const selectedFolderInfo = document.getElementById('selectedDLFolderInfo');
        const selectedFolderName = document.getElementById('selectedDLFolderName');
        
        // Store current browsing path and selected info
        let currentPath = [];
        let selectedFolderId = null;
        let currentMagnetLink = '';
        let currentMagnetTitle = '';
        
        // Format file size
        function formatFileSize(bytes) {
            if (typeof bytes === 'string' && bytes.trim() !== '') {
                // If we already have a formatted string like "1.1GB", just return it
                return bytes;
            }
            
            // If it's a number or can be converted to a number, format it
            if (bytes === 0 || isNaN(parseInt(bytes))) return 'N/A';
            
            bytes = parseInt(bytes);
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }
        
        // Load directory contents
        function loadDirectory(folderId) {
            // Show loading
            loadingRow.classList.remove('d-none');
            noFilesAlert.classList.add('d-none');
            
            // Clear file list (keep loading row)
            const rows = fileList.querySelectorAll('tr:not(#cloud115DLLoading)');
            rows.forEach(row => row.remove());
            
            // Request API to get file list
            fetch(`/api/cloud115/files?cid=${folderId}`)
                .then(response => response.json())
                .then(data => {
                    loadingRow.classList.add('d-none');
                    
                    if (data.state && data.data && Array.isArray(data.data)) {
                        if (data.data.length === 0) {
                            // No files
                            noFilesAlert.classList.remove('d-none');
                        } else {
                            // Render file list
                            data.data.forEach((file, index) => {
                                const isFolder = file.fc === '0';
                                
                                const row = document.createElement('tr');
                                row.className = isFolder ? 'folder-row' : '';
                                row.innerHTML = `
                                    <td>${index + 1}</td>
                                    <td>
                                        <i class="${isFolder ? 'fas fa-folder text-warning' : 'fas fa-file text-primary'} me-2"></i>
                                        <span class="file-name">${file.fn}</span>
                                    </td>
                                    <td>${formatFileSize(parseInt(file.fs || 0))}</td>
                                    <td>${formatTimestamp(file.upt)}</td>
                                    <td>
                                        ${isFolder ? 
                                        `<div class="form-check">
                                            <input class="form-check-input folder-select" type="radio" name="dlFolderSelect" 
                                                id="dlFolder${file.fid}" value="${file.fid}" data-folder-name="${file.fn}">
                                            <label class="form-check-label" for="dlFolder${file.fid}">
                                                选择
                                            </label>
                                        </div>` : ''}
                                    </td>
                                `;
                                
                                // Add click event (only folders can be clicked)
                                if (isFolder) {
                                    const nameCell = row.querySelector('.file-name');
                                    nameCell.style.cursor = 'pointer';
                                    nameCell.title = '点击进入文件夹';
                                    nameCell.addEventListener('click', () => navigateToFolder(file.fid, file.fn));
                                }
                                
                                fileList.appendChild(row);
                            });
                            
                            // Add folder selection events
                            document.querySelectorAll('.folder-select').forEach(radio => {
                                radio.addEventListener('change', function() {
                                    selectedFolderId = this.value;
                                    selectedFolderName.textContent = this.getAttribute('data-folder-name');
                                    selectedFolderInfo.classList.remove('d-none');
                                    confirmBtn.disabled = false;
                                });
                            });
                        }
                    } else {
                        // Loading failed
                        noFilesAlert.textContent = '加载文件列表失败';
                        noFilesAlert.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('加载目录错误:', error);
                    loadingRow.classList.add('d-none');
                    noFilesAlert.textContent = '加载文件列表失败，请重试';
                    noFilesAlert.classList.remove('d-none');
                });
        }
        
        // Navigate to specific folder
        function navigateToFolder(folderId, folderName) {
            // Update breadcrumb
            updateBreadcrumb(folderId, folderName);
            
            // Load folder contents
            loadDirectory(folderId);
        }
        
        // Update breadcrumb navigation
        function updateBreadcrumb(folderId, folderName) {
            // Check if path already exists (when clicking breadcrumb)
            const existingIndex = currentPath.findIndex(p => p.id === folderId);
            
            if (existingIndex !== -1) {
                // If clicking existing path, truncate to that path
                currentPath = currentPath.slice(0, existingIndex + 1);
            } else {
                // Add new path
                currentPath.push({ id: folderId, name: folderName });
            }
            
            // Re-render breadcrumb
            breadcrumb.innerHTML = `<li class="breadcrumb-item" data-folder-id="0"><a href="#" class="breadcrumb-link">根目录</a></li>`;
            
            currentPath.forEach((path, index) => {
                const isLast = index === currentPath.length - 1;
                const item = document.createElement('li');
                item.className = isLast ? 'breadcrumb-item active' : 'breadcrumb-item';
                item.setAttribute('data-folder-id', path.id);
                
                if (isLast) {
                    item.textContent = path.name;
                } else {
                    item.innerHTML = `<a href="#" class="breadcrumb-link">${path.name}</a>`;
                }
                
                breadcrumb.appendChild(item);
            });
            
            // Add click events for breadcrumb items
            breadcrumb.querySelectorAll('.breadcrumb-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const li = this.closest('li');
                    const folderId = li.getAttribute('data-folder-id');
                    
                    // If clicking "root directory", clear current path
                    if (folderId === '0') {
                        currentPath = [];
                        navigateToFolder(0, '根目录');
                    } else {
                        // Find clicked path in current path
                        const pathIndex = currentPath.findIndex(p => p.id === folderId);
                        if (pathIndex !== -1) {
                            // Navigate to that path
                            navigateToFolder(folderId, currentPath[pathIndex].name);
                        }
                    }
                });
            });
        }
        
        // Show the Add to 115 modal
        window.showAddTo115Modal = function(button) {
            // Get magnet link and title
            currentMagnetLink = button.getAttribute('data-magnet');
            currentMagnetTitle = button.getAttribute('data-title');
            
            // Display magnet info
            document.getElementById('magnetInfo').textContent = currentMagnetTitle || currentMagnetLink;
            
            // Reset state
            breadcrumb.innerHTML = '<li class="breadcrumb-item active" data-folder-id="0">根目录</li>';
            currentPath = [];
            selectedFolderId = null;
            confirmBtn.disabled = true;
            selectedFolderInfo.classList.add('d-none');
            
            // Check login status
            fetch('/api/cloud115/check_auth_status')
                .then(response => response.json())
                .then(data => {
                    if (data.state === 1 && data.data && data.data.logged_in) {
                        // Logged in, load root directory
                        loadDirectory(0);
                        notLoggedInAlert.classList.add('d-none');
                    } else {
                        // Not logged in, show alert
                        loadingRow.classList.add('d-none');
                        notLoggedInAlert.classList.remove('d-none');
                    }
                })
                .catch(error => {
                    console.error('检查登录状态错误:', error);
                    notLoggedInAlert.classList.remove('d-none');
                    loadingRow.classList.add('d-none');
                });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addTo115Modal'));
            modal.show();
        };
        
        // Confirm add to 115 button click event
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function() {
                if (!currentMagnetLink) {
                    alert('磁力链接无效');
                    return;
                }
                
                // Show loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 添加中...';
                
                // Send request to add offline download task
                fetch('/api/cloud115/add_offline_download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        urls: currentMagnetLink,
                        wp_path_id: selectedFolderId || '0'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Restore button state
                    this.disabled = false;
                    this.innerHTML = '确定添加';
                    
                    if (data.success) {
                        // Add successful, close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addTo115Modal'));
                        modal.hide();
                        
                        // Show success message
                        alert('添加离线下载任务成功！');
                    } else {
                        // Add failed
                        alert('添加离线下载任务失败：' + (data.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('添加离线下载错误:', error);
                    this.disabled = false;
                    this.innerHTML = '确定添加';
                    alert('添加离线下载任务请求失败，请重试');
                });
            });
        }
    });

    // 添加到片库的函数
    window.addToLibrary = function(button) {
        // 获取磁力链接和标题
        const magnetLink = button.getAttribute('data-magnet');
        const magnetTitle = button.getAttribute('data-title');
        const movieId = button.getAttribute('data-movie-id');
        
        if (!magnetLink) {
            alert('磁力链接无效');
            return;
        }
        
        // 显示加载状态
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
        
        // 准备请求参数
        const requestData = {
            urls: magnetLink,
            movie_info: {}
        };
        
        // 如果有影片ID，添加到请求中
        if (movieId) {
            requestData.movie_info.movie_id = movieId;
        }
        
        // 发送请求加入片库
        fetch('/api/cloud115/add_to_library', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // 恢复按钮状态
            button.disabled = false;
            button.innerHTML = originalHTML;
            
            if (data.success) {
                // 添加成功
                alert('已添加到离线下载队列，并设置后台自动加入片库！');
            } else {
                // 添加失败
                alert('加入片库失败：' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('加入片库错误:', error);
            button.disabled = false;
            button.innerHTML = originalHTML;
            alert('加入片库请求失败，请重试');
        });
    };

    // 折叠/展开功能
    document.addEventListener('DOMContentLoaded', function() {
        // 处理 Summary 折叠/展开
        const summaryCollapse = document.getElementById('summaryContent');
        if (summaryCollapse) {
            summaryCollapse.addEventListener('show.bs.collapse', function() {
                const toggleText = document.querySelector('.summary-toggle-text');
                const toggleIcon = document.querySelector('.summary-toggle-icon');
                if (toggleText) toggleText.textContent = '收起';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-up';
            });
            
            summaryCollapse.addEventListener('hide.bs.collapse', function() {
                const toggleText = document.querySelector('.summary-toggle-text');
                const toggleIcon = document.querySelector('.summary-toggle-icon');
                if (toggleText) toggleText.textContent = '展开';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-down';
            });
        }

        // 处理用户评价折叠/展开
        const reviewsCollapse = document.getElementById('userReviewsContent');
        if (reviewsCollapse) {
            reviewsCollapse.addEventListener('show.bs.collapse', function() {
                const toggleText = document.querySelector('.reviews-toggle-text');
                const toggleIcon = document.querySelector('.reviews-toggle-icon');
                if (toggleText) toggleText.textContent = '收起';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-up';
            });
            
            reviewsCollapse.addEventListener('hide.bs.collapse', function() {
                const toggleText = document.querySelector('.reviews-toggle-text');
                const toggleIcon = document.querySelector('.reviews-toggle-icon');
                if (toggleText) toggleText.textContent = '展开';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-down';
            });
        }

        // 处理异步用户评价折叠/展开
        const asyncReviewsCollapse = document.getElementById('asyncUserReviewsContent');
        if (asyncReviewsCollapse) {
            asyncReviewsCollapse.addEventListener('show.bs.collapse', function() {
                const toggleText = document.querySelector('.async-reviews-toggle-text');
                const toggleIcon = document.querySelector('.async-reviews-toggle-icon');
                if (toggleText) toggleText.textContent = '收起';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-up';
            });
            
            asyncReviewsCollapse.addEventListener('hide.bs.collapse', function() {
                const toggleText = document.querySelector('.async-reviews-toggle-text');
                const toggleIcon = document.querySelector('.async-reviews-toggle-icon');
                if (toggleText) toggleText.textContent = '展开';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-down';
            });
        }
    });

    // 动态加载用户评价的函数
    function loadUserReviews(userReviews) {
        if (!userReviews || userReviews.length === 0) return;
        
        const container = document.getElementById('async-user-reviews-container');
        const title = document.getElementById('async-user-reviews-title');
        const content = document.getElementById('async-user-reviews-content');
        
        if (container && title && content) {
            title.textContent = `用户评价 (${userReviews.length}条):`;
            
            let reviewsHTML = '';
            userReviews.forEach(review => {
                reviewsHTML += `
                    <div class="card mt-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    ${review.title ? `<h6 class="card-title mb-1">${review.title}</h6>` : ''}
                                    ${review.rating ? `<span class="badge bg-warning me-2">评分: ${review.rating}</span>` : ''}
                                </div>
                                <div class="text-muted small">
                                    ${review.reviewer ? `<div>评价者: ${review.reviewer}</div>` : ''}
                                    ${review.post_date ? `<div>${review.post_date}</div>` : ''}
                                </div>
                            </div>
                            ${review.comment ? `<div class="card-text" style="white-space: pre-line;">${review.comment}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = reviewsHTML;
            container.style.display = 'block';
        }
    }

    // 初始化演员头像 tooltip
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化所有 Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

    // 刷新演员 AV-League 数据
    async function refreshActorAvLeague(actorId, actorName) {
        const badge = document.querySelector(`[onclick*="refreshActorAvLeague('${actorId}'"]`);

        if (badge) {
            const originalClass = badge.className;
            badge.className = 'badge bg-warning';
            badge.innerHTML = '...';

            // 添加 tooltip 提示正在刷新
            const tooltip = bootstrap.Tooltip.getInstance(badge);
            if (tooltip) {
                tooltip.dispose();
            }
        }

        try {
            const response = await fetch('/api/actor/' + actorId + '/refresh-av-league', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (result.success && result.data) {
                alert('已成功更新演员 ' + actorName + ' 的 AV-League 数据！\n页面将刷新以显示最新信息。');
                location.reload();
            } else {
                if (badge) {
                    badge.className = 'badge bg-secondary';
                    badge.innerHTML = 'AV';
                }
                alert('AV-League 上未找到演员: ' + actorName);
            }
        } catch (error) {
            console.error('刷新 AV-League 数据失败:', error);
            if (badge) {
                badge.className = 'badge bg-danger';
                badge.innerHTML = 'AV';
            }
            alert('刷新失败: ' + error.message);
        }
    }
</script>
{% endblock %} 